<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<!-- generated by to_html.pl from simple.xml -->
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Basic usage</title>
	<meta name="author" content="W.Dee" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<meta http-equiv="Content-Script-Type" content="text/javascript" />
	<link href="browser.css" type="text/css" rel="stylesheet" title="吉里吉里関連リファレンス用標準スタイル" />
	<link href="mailto:dee@kikyou.info" rev="Made" />
	<link href="index.html" target="_top" rel="Start" title="トップページ" />
</head>
<body>
<h1><a id="id320" name="id320">compile</a>
</h1><div class="para"><div>
　You can compile with Borland C++ 5.5 or later (C++ Builder 5 or later).<br />
<br />
　Compilation requires regex++ from boost.org.<br />
<br />
　After installing regex++, compile each cpp file.<br />
<br />
　In the case of C++ Builder, it is OK just to add to all projects each cpp file of tjs2.<br />
<br />
　You can compile even gcc 3 or later (you can compile even 2.95 but must be related fixes wstring).<br />
</div></div>
<h1><a id="id321" name="id321">A simple example</a>
</h1><div class="para"><div>
<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>#include&nbsp;&lt;stdio.h&gt;<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>#include&nbsp;&quot;tjs.h&quot;<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>#include&nbsp;&quot;tjsError.h&quot;<br />
<span class="linenumber">&nbsp;&nbsp;4|</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>int&nbsp;main(int&nbsp;argc,&nbsp;char*&nbsp;argv[])<br />
<span class="linenumber">&nbsp;&nbsp;6|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;setlocale(LC_ALL,&nbsp;&quot;&quot;);&nbsp;<span class="comment">//&nbsp;Setting&nbsp;the&nbsp;locale</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span><br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;tTJS&nbsp;*tjsengine&nbsp;=&nbsp;new&nbsp;tTJS();&nbsp;<span class="comment">//&nbsp;Create&nbsp;TJS2&nbsp;script&nbsp;engine</span><br />
<span class="linenumber">&nbsp;10|</span><br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;try<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;result;&nbsp;<span class="comment">//&nbsp;Variable&nbsp;to&nbsp;receive&nbsp;the&nbsp;result</span><br />
<span class="linenumber">&nbsp;14|</span><br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;ExecScript(<br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_W(<br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;function&nbsp;test(x,&nbsp;y)&nbsp;{&nbsp;return&nbsp;x*y;&nbsp;}&nbsp;\n&quot;<br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;return&nbsp;test(4,&nbsp;5);\n&quot;),<br />
<span class="linenumber">&nbsp;19|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;result,&nbsp;NULL,<br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_W(&quot;test&nbsp;code&quot;));&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Run&nbsp;the&nbsp;test&nbsp;script</span><br />
<span class="linenumber">&nbsp;21|</span><br />
<span class="linenumber">&nbsp;22|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Result:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;Show&nbsp;results</span><br />
<span class="linenumber">&nbsp;23|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;24|</span>&nbsp;&nbsp;&nbsp;&nbsp;catch(eTJSError&nbsp;&amp;e)<br />
<span class="linenumber">&nbsp;25|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;26|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;An&nbsp;error&nbsp;has&nbsp;occurred:&nbsp;%ls\n&quot;,&nbsp;e.GetMessage().c_str());<br />
<span class="linenumber">&nbsp;27|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;28|</span>&nbsp;&nbsp;&nbsp;&nbsp;catch(...)<br />
<span class="linenumber">&nbsp;29|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;30|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;An&nbsp;error&nbsp;has&nbsp;occurred\n&quot;);<br />
<span class="linenumber">&nbsp;31|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;32|</span><br />
<span class="linenumber">&nbsp;33|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;Shutdown();&nbsp;<span class="comment">//&nbsp;Shut&nbsp;down&nbsp;TJS2&nbsp;script&nbsp;engine</span><br />
<span class="linenumber">&nbsp;34|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;Release();&nbsp;<span class="comment">//&nbsp;Release&nbsp;TJS2&nbsp;script&nbsp;engine</span><br />
<span class="linenumber">&nbsp;35|</span><br />
<span class="linenumber">&nbsp;36|</span>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br />
<span class="linenumber">&nbsp;37|</span>}<br />
</code>
<br />

<br />
<dl>
<dt>Lines 2 through 3</dt>
<dd>　Loading the header files needed to use the TJS2. tjsError.h contains declarations for TJS C++ exceptions.</dd>


<dt>Line 7</dt>
<dd>　The locale is specified by setlocale. If the locale is not specified, the &quot;C&quot; locale will result, and conversion between Japanese narrow and wide characters will not work.</dd>


<dt>Line 9</dt>
<dd>　The TJS2 script engine is created with the new operator.</dd>


<dt>Line 11</dt>
<dd>　It is in a try block. TJS2 errors are signaled by exceptions, so care must be taken in exception handling.</dd>


<dt>Line 13</dt>
<dd>　Declares a tTJSVariant type variable to receive the result of executing the script.</dd>


<dt>Lines 15 through 20</dt>
<dd>　Script is executed using tTJS::ExecScript.<br />
　Specify the script to be executed as the first argument. String literals are converted to wide strings using the TJS_W macro to pass in the tjs_char * type. The script defines a function test and returns the result of calling that function.<br />
　In this example, the result of the execution is returned by the return statement, and it is received in the result variable. If it is not necessary to receive the result, neither the return statement nor the second argument of tTJS::ExecScript is required (in that case, 2 The second argument is NULL).<br />
　The third argument of tTJS::ExecScript is the execution context, but specify NULL here. If NULL is specified, the script will be executed in the global context.<br />
　The fourth argument of tTJS::ExecScript specifies the name of this script. If NULL, it is treated as anonymous. The name must be human readable.</dd>


<dt>Line 22</dt>
<dd>　Showing results. Here, tTJSVariant is cast to int type.</dd>


<dt>Line 24</dt>
<dd>　An eTJSError type exception has been received.</dd>


<dt>Line 26</dt>
<dd>　eTJSError::GetMessage is used to display the reason for the exception. We use tTJSString::c_str to convert the message to const tjs_char *. Since tjs_char is a wide character, printf specifies %ls as the conversion specifier.</dd>


<dt>Line 28</dt>
<dd>　I am receiving other exceptions.</dd>


<dt>Lines 33 through 34</dt>
<dd>　Releasing TJS2 script engine. Prior to release, the TJS2 script engine is shut down using tTJS::Shutdown.</dd></dl></div></div>

<h1><a id="id322" name="id322">Calling TJS2 function</a>
</h1><div class="para"><div>
　In this method, the function declared on the TJS2 side is called from C++.<br />
　Let's write in the above try block as follows.<br />
<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;result;&nbsp;<span class="comment">//&nbsp;Variable&nbsp;to&nbsp;receive&nbsp;the&nbsp;result</span><br />
<span class="linenumber">&nbsp;&nbsp;2|</span><br />
<span class="linenumber">&nbsp;&nbsp;3|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;ExecScript(<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_W(&quot;function&nbsp;test(x,&nbsp;y)&nbsp;{&nbsp;return&nbsp;x*y;&nbsp;}&quot;),&nbsp;NULL,&nbsp;NULL,&nbsp;TJS_W(&quot;test&quot;));<br />
<span class="linenumber">&nbsp;&nbsp;5|</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;EvalExpression(TJS_W(&quot;test(4,&nbsp;5)&quot;),&nbsp;&amp;result,&nbsp;NULL,&nbsp;NULL);<br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Execute&nbsp;expression&nbsp;using&nbsp;tTJS::EvalExpression</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span><br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Result:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;Show&nbsp;results</span><br />
<span class="linenumber">&nbsp;10|</span><br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*&nbsp;global&nbsp;=&nbsp;tjsengine-&gt;GetGlobalNoAddRef();<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Get&nbsp;global&nbsp;object</span><br />
<span class="linenumber">&nbsp;13|</span><br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;param[]&nbsp;=&nbsp;{&nbsp;4,&nbsp;5&nbsp;};&nbsp;<span class="comment">//&nbsp;Variables&nbsp;passed&nbsp;as&nbsp;parameters</span><br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;*p_param[]&nbsp;=&nbsp;{&nbsp;param&nbsp;+&nbsp;0,&nbsp;param&nbsp;+&nbsp;1&nbsp;};&nbsp;<span class="comment">//&nbsp;Array&nbsp;of&nbsp;pointers&nbsp;to&nbsp;variables</span><br />
<span class="linenumber">&nbsp;16|</span><br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_THROW_IF_ERROR(global-&gt;FuncCall(0,&nbsp;TJS_W(&quot;test&quot;),&nbsp;NULL,&nbsp;&amp;result,&nbsp;2,&nbsp;p_param,&nbsp;NULL));<br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Call&nbsp;test&nbsp;as&nbsp;a&nbsp;function</span><br />
<span class="linenumber">&nbsp;19|</span><br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Result:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;Show&nbsp;results</span><br />
</code>
<br />

<br />
<dl>
<dt>Lines 3 through 4</dt>
<dd>　Declares function test. test is registered to global.</dd>


<dt>Line 6</dt>
<dd>　An expression is executed using tTJS::EvalExpression. If you don't need to be very fast, it's easy to pass the expression as a string and receive the result.<br />
　By the way, for simple expressions (such as those that do not include other execution units, such as function declarations), the compilation results are cached to some extent, and the second and subsequent expressions can be evaluated at high speed.</dd>


<dt>Line 11</dt>
<dd>　Getting global object. The difference between tTJS::GetGlobal and tTJS::GetGlobalNoAddRef is that the former increments the reference counter of the global object, while the latter does not.<br />
　Incrementing the reference counter and decrementing when you are done with it means locking the object in the meantime so that it does not disappear. If you do not have to worry about the global object disappearing like this example, you do not need to manipulate the reference counter, so you can use tTJS::GetGlobalNoAddRef. In this case, you do not need a Release when you have finished using it.</dd>


<dt>Lines 14 through 15</dt>
<dd>　Preparing parameters to pass to the function. This preparation is necessary because iTJSDispatch :: FuncCall requires an array of tTJSVariant pointers as parameters to be passed to the function.</dd>


<dt>Line 17</dt>
<dd>　Function &quot;test&quot; is called using iTJSDispatch2::FuncCall.<br />
　The last argument of FuncCall is this (execution context) passed to the function test, but NULL can be specified because this is not used in the test declared in this example. If there is a context to execute, you must specify that object.<br />
　TJS_THROW_IF_ERROR is a macro that raises an exception with the corresponding error message when the result of tjs_error type is an error.</dd></dl></div></div>

<h1><a id="id323" name="id323">Native functions</a>
</h1><div class="para"><div>
　You can create native implementations (functions implemented in C++ etc.) and access them from the TJS2 side.<br />
　You can call functions written in any language that can implement iTJSDispatch2 without using C++, but C++ is the easiest.<br />
<br />
　When writing a function in C++, it is easy to derive a class from tTJSNativeFunction (described in tjsNative.h). (However, it is possible to operate as a function just by implementing FuncCall of iTJSDispatch2.)<br />
<br />
　Let's implement a simple function that multiplies two given arguments and returns them.<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>class&nbsp;TestFunc&nbsp;:&nbsp;public&nbsp;tTJSNativeFunction<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>public:<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_error&nbsp;Process(tTJSVariant&nbsp;*result,&nbsp;tjs_int&nbsp;numparams,<br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;**param,&nbsp;iTJSDispatch2&nbsp;*objthis)<br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(numparams&nbsp;&lt;&nbsp;2)&nbsp;return&nbsp;TJS_E_BADPARAMCOUNT;&nbsp;<span class="comment">//&nbsp;Not&nbsp;enough&nbsp;arguments</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span><br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!result)&nbsp;return&nbsp;TJS_S_OK;&nbsp;<span class="comment">//&nbsp;Return&nbsp;if&nbsp;no&nbsp;need&nbsp;to&nbsp;store&nbsp;result</span><br />
<span class="linenumber">&nbsp;10|</span><br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*result&nbsp;=&nbsp;*param[0]&nbsp;*&nbsp;*param[1];&nbsp;<span class="comment">//&nbsp;Calculation</span><br />
<span class="linenumber">&nbsp;12|</span><br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;&nbsp;<span class="comment">//&nbsp;Returns&nbsp;TJS_S_OK&nbsp;to&nbsp;indicate&nbsp;success</span><br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;15|</span>};<br />
</code>
<br />

<br />
　The only method that should be implemented in a class that inherits tTJSNativeFunction is the Process method as described above.<br />
　The arguments of the Process method are as follows.<br />
<br />
<dl>
<dt>tTJSVariant *result</dt>
<dd>　A pointer to a variable of type tTJSVariant for storing the result of the function is passed. Note that <em>NULL is passed if the caller does not need the result</em>.</dd>


<dt>tjs_int numparams</dt>
<dd>　Number of arguments passed to the function.</dd>


<dt>tTJSVariant **param</dt>
<dd>　An array of pointers to tTJSVariant variables that contain the arguments passed to the function.</dd>


<dt>iTJSDispatch2 *objthis</dt>
<dd>　The context in which the function should be executed. If you are implementing a context-independent implementation, you can ignore it.</dd></dl><br />
<br />
<br />
　To make a native function accessible from TJS2, it must be registered with an object accessible from within TJS2. In the following example, it is registered as &quot;test&quot; in global. Also, it actually calls that function.<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*&nbsp;global&nbsp;=&nbsp;tjsengine-&gt;GetGlobalNoAddRef();<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Get&nbsp;global&nbsp;object</span><br />
<span class="linenumber">&nbsp;&nbsp;3|</span><br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*func&nbsp;=&nbsp;new&nbsp;TestFunc();&nbsp;<span class="comment">//&nbsp;Create&nbsp;TestFunc&nbsp;object</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;func_var(func);&nbsp;<span class="comment">//&nbsp;Set&nbsp;object&nbsp;to&nbsp;tTJSVariant&nbsp;type&nbsp;func_var</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func-&gt;Release();&nbsp;<span class="comment">//&nbsp;Release&nbsp;func</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_THROW_IF_ERROR(<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global-&gt;PropSet(TJS_MEMBERENSURE,&nbsp;TJS_W(&quot;test&quot;),&nbsp;NULL,&nbsp;&amp;func_var,&nbsp;NULL));<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Register</span><br />
<span class="linenumber">&nbsp;11|</span><br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;result;&nbsp;<span class="comment">//&nbsp;Variable&nbsp;to&nbsp;receive&nbsp;the&nbsp;result</span><br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;EvalExpression(TJS_W(&quot;test(4,&nbsp;5)&quot;),&nbsp;&amp;result,&nbsp;NULL,&nbsp;NULL);<br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Execute&nbsp;expression&nbsp;using&nbsp;tTJS::EvalExpression</span><br />
<span class="linenumber">&nbsp;15|</span><br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Result:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;Show&nbsp;results</span><br />
</code>
<br />

<br />
<dl>
<dt>Lines 4 through 6</dt>
<dd>　Creates an object of class TestFunc that implements native functions and converts it to tTJSVariant type.<br />
　In line 5, the function is converted to tTJSVariant type. At this point, since the tTJSVariant type automatically manages the reference counter of the function object, the function object is released in line 6.</dd>


<dt>Lines 8 through 9</dt>
<dd>　The function is registered as &quot;test&quot; in the global object. It calls the global object iTJSDispatch2::PropSet with the TJS_MEMBERENSURE flag to create a new member.</dd>


<dt>Lines 12 through 16</dt>
<dd>　Calls the function and displays the result.</dd></dl></div></div>
<h1><a id="id324" name="id324">Native class</a>
</h1><div class="para"><div>
　TJS2 has a mechanism for handling native classes written in languages such as C++.<br />
　Each object (iTJSDispatch2 interface) can register an object of type iTJSNativeInstance called a native instance, which can be extracted from the object.<br />
　Native instances are identified by a unique class ID, and you need to get the class ID when you create a native class.<br />
<br />
　However, macros for performing these operations are defined in tjsNative.h, so it is easy to use them.<br />
　The following example implements a simple class using these macros.<br />
<br />
　First, the implementation of the native instance. To implement a native instance, derive a class from tTJSNativeInstance. tTJSNativeInstance is a class implemented in tjsNative.cpp / tjsNative.h, and implements the basic operation of iTJSNativeInstance.<br />
<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>class&nbsp;NI_Test&nbsp;:&nbsp;public&nbsp;tTJSNativeInstance&nbsp;<span class="comment">//&nbsp;Native&nbsp;instance</span><br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>public:<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;NI_Test()<br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;constructor</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;=&nbsp;0;<br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;&nbsp;9|</span><br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_error&nbsp;TJS_INTF_METHOD<br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Construct(tjs_int&nbsp;numparams,&nbsp;tTJSVariant&nbsp;**param,&nbsp;iTJSDispatch2&nbsp;*tjs_obj)<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Called&nbsp;when&nbsp;a&nbsp;TJS2&nbsp;object&nbsp;is&nbsp;created</span><br />
<span class="linenumber">&nbsp;14|</span><br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;If&nbsp;there&nbsp;is&nbsp;an&nbsp;argument,&nbsp;put&nbsp;it&nbsp;in&nbsp;Value&nbsp;as&nbsp;the&nbsp;initial&nbsp;value</span><br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(numparams&nbsp;&gt;=&nbsp;1&nbsp;&amp;&amp;&nbsp;param[0]-&gt;Type()&nbsp;!=&nbsp;tvtVoid)<br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;=&nbsp;(tjs_int)*param[0];<br />
<span class="linenumber">&nbsp;18|</span><br />
<span class="linenumber">&nbsp;19|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;S_OK;<br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;21|</span><br />
<span class="linenumber">&nbsp;22|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;TJS_INTF_METHOD&nbsp;Invalidate()<br />
<span class="linenumber">&nbsp;23|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;24|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Called&nbsp;when&nbsp;the&nbsp;object&nbsp;is&nbsp;invalidated</span><br />
<span class="linenumber">&nbsp;25|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;26|</span><br />
<span class="linenumber">&nbsp;27|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;SetValue(tjs_int&nbsp;n)&nbsp;{&nbsp;Value&nbsp;=&nbsp;n;&nbsp;}<br />
<span class="linenumber">&nbsp;28|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_int&nbsp;GetValue()&nbsp;const&nbsp;{&nbsp;return&nbsp;Value;&nbsp;}<br />
<span class="linenumber">&nbsp;29|</span><br />
<span class="linenumber">&nbsp;30|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_int&nbsp;GetSquare()&nbsp;const&nbsp;{&nbsp;return&nbsp;Value*Value;&nbsp;}<br />
<span class="linenumber">&nbsp;31|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;Add(tjs_int&nbsp;n)&nbsp;{&nbsp;Value&nbsp;+=&nbsp;n;&nbsp;}<br />
<span class="linenumber">&nbsp;32|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;Print()&nbsp;const&nbsp;{&nbsp;printf(&quot;%d\n&quot;,&nbsp;Value);&nbsp;}<br />
<span class="linenumber">&nbsp;33|</span><br />
<span class="linenumber">&nbsp;34|</span>private:<br />
<span class="linenumber">&nbsp;35|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_int&nbsp;Value;&nbsp;<span class="comment">//&nbsp;Value</span><br />
<span class="linenumber">&nbsp;36|</span>};<br />
</code>
<br />

<br />
<dl>
<dt>Line 35</dt>
<dd>　Before and after, it's a data member. The required data members can be freely written in the native instance.</dd>

<dt>Lines 4 through 8</dt>
<dd>　Constructor for NI_Test. It is recommended that initialization as a C++ class be done here rather than Construct described later, and that initialization in Construct be minimized.<br />
　In this example, the value of the data member is set to 0 as the initial value.</dd>


<dt>Lines10 through 20</dt>
<dd>　Called when a TJS2 object is created with the new operator. The numparams and param arguments represent the arguments passed to the new operator.<br />
　The tjs_obj argument is the TJS object to be created.<br />
　In this example, if there is an argument (and it is not void), it sets it as the initial value of Value.</dd>


<dt>Lines 22 through 25</dt>
<dd>　Method called when the object is invalidated. It is good to write the end processing here.<br />
　Do nothing in this example.</dd>


<dt>Lines 27 through 32</dt>
<dd>　Public methods for manipulating data members. Write the code that uses these in the native class described later.</dd></dl><br />
　You need a class to create an object, so write the class. The class is implemented by deriving tTJSNativeClass. tTJSNativeClass has the iTJSDispatch2 interface, which implements the basic behavior for acting as a native class.<br />
　The methods and properties accessible from TJS are described in the constructor of the native class.<br />
<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>class&nbsp;NC_Test&nbsp;:&nbsp;public&nbsp;tTJSNativeClass&nbsp;<span class="comment">//&nbsp;Native&nbsp;class</span><br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>public:<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;NC_Test();&nbsp;<span class="comment">//&nbsp;Constructor;&nbsp;described&nbsp;below</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;tjs_uint32&nbsp;ClassID;&nbsp;<span class="comment">//&nbsp;Class&nbsp;ID</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span>private:<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;tTJSNativeInstance&nbsp;*CreateNativeInstance()<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;NI_Test();&nbsp;<span class="comment">//&nbsp;Create&nbsp;and&nbsp;return&nbsp;a&nbsp;native&nbsp;instance</span><br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;13|</span>};<br />
<span class="linenumber">&nbsp;14|</span>tjs_uint32&nbsp;NC_Test::ClassID&nbsp;=&nbsp;(tjs_uint32)-1;&nbsp;<span class="comment">//&nbsp;Class&nbsp;ID</span><br />
</code>
<br />

<br />
<dl>
<dt>Line 4</dt>
<dd>　The constructor for this class. The implementation will be described later.</dd>


<dt>Line 6</dt>
<dd>　Variable to hold the class ID of this class. The substance is on line 14.</dd>


<dt>Lines 9 through 12</dt>
<dd>　CreateNativeInstance method is called when the native instance should be created. Here we create and return an object of class NI_Test.</dd></dl><br />
<br />
<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>NC_Test::NC_Test()&nbsp;:&nbsp;tTJSNativeClass(TJS_W(&quot;Test&quot;))<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_MEMBERS(<span class="comment">/*TJS&nbsp;class&nbsp;name*/</span>Test)<br />
<span class="linenumber">&nbsp;&nbsp;4|</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_DECL_EMPTY_FINALIZE_METHOD<br />
<span class="linenumber">&nbsp;&nbsp;6|</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_CONSTRUCTOR_DECL(<br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.name*/</span>_this,<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.type*/</span>NI_Test,<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*TJS&nbsp;class&nbsp;name*/</span>Test)<br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Since&nbsp;nothing&nbsp;can&nbsp;be&nbsp;described&nbsp;in&nbsp;NI_Test::Construct,&nbsp;nothing&nbsp;is&nbsp;done&nbsp;here</span><br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_CONSTRUCTOR_DECL(<span class="comment">/*TJS&nbsp;class&nbsp;name*/</span>Test)<br />
<span class="linenumber">&nbsp;16|</span><br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_METHOD_DECL(<span class="comment">/*func.&nbsp;name*/</span>print)&nbsp;<span class="comment">//&nbsp;print&nbsp;method</span><br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;19|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;21|</span><br />
<span class="linenumber">&nbsp;22|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_this-&gt;Print();<br />
<span class="linenumber">&nbsp;23|</span><br />
<span class="linenumber">&nbsp;24|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;25|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;26|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_METHOD_DECL(<span class="comment">/*func.&nbsp;name*/</span>print)<br />
<span class="linenumber">&nbsp;27|</span><br />
<span class="linenumber">&nbsp;28|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_METHOD_DECL(<span class="comment">/*func.&nbsp;name*/</span>add)&nbsp;<span class="comment">//&nbsp;add&nbsp;method</span><br />
<span class="linenumber">&nbsp;29|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;30|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;31|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;32|</span><br />
<span class="linenumber">&nbsp;33|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(numparams&nbsp;&lt;&nbsp;1)&nbsp;return&nbsp;TJS_E_BADPARAMCOUNT;<br />
<span class="linenumber">&nbsp;34|</span><br />
<span class="linenumber">&nbsp;35|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_this-&gt;Add((tjs_int)*param[0]);<br />
<span class="linenumber">&nbsp;36|</span><br />
<span class="linenumber">&nbsp;37|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;38|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;39|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_METHOD_DECL(<span class="comment">/*func.&nbsp;name*/</span>add)<br />
<span class="linenumber">&nbsp;40|</span><br />
<span class="linenumber">&nbsp;41|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_DECL(value)&nbsp;<span class="comment">//&nbsp;value&nbsp;property</span><br />
<span class="linenumber">&nbsp;42|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;43|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;44|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;45|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;46|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;47|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*result&nbsp;=&nbsp;_this-&gt;GetValue();<br />
<span class="linenumber">&nbsp;48|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;49|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;50|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;51|</span><br />
<span class="linenumber">&nbsp;52|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_SETTER<br />
<span class="linenumber">&nbsp;53|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;54|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;55|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;56|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_this-&gt;SetValue((tjs_int)*param);<br />
<span class="linenumber">&nbsp;57|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;58|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;59|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_SETTER<br />
<span class="linenumber">&nbsp;60|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;61|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_DECL(value)<br />
<span class="linenumber">&nbsp;62|</span><br />
<span class="linenumber">&nbsp;63|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_DECL(square)&nbsp;<span class="comment">//&nbsp;square&nbsp;read-only&nbsp;property</span><br />
<span class="linenumber">&nbsp;64|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;65|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;66|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;67|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;68|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;69|</span><br />
<span class="linenumber">&nbsp;70|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*result&nbsp;=&nbsp;_this-&gt;GetSquare();<br />
<span class="linenumber">&nbsp;71|</span><br />
<span class="linenumber">&nbsp;72|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;73|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;74|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;75|</span><br />
<span class="linenumber">&nbsp;76|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_DENY_NATIVE_PROP_SETTER<br />
<span class="linenumber">&nbsp;77|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;78|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_DECL(square)<br />
<span class="linenumber">&nbsp;79|</span><br />
<span class="linenumber">&nbsp;80|</span>&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_MEMBERS<br />
<span class="linenumber">&nbsp;81|</span>}<br />
</code>
<br />

<br />
<dl>
<dt>Line 1</dt>
<dd>　Constructor for NC_Test. In the constructor of the parent class, tTJSNativeClass, specify the class name used in TJS2.</dd>


<dt>Line 3</dt>
<dd>　TJS_BEGIN_NATIVE_MEMBERS macro. Specify the class name used in TJS2 in the argument.<br />
　In the place between this macro and the TJS_END_NATIVE_MEMBERS macro, describe the methods and properties that should be members of the class.</dd>


<dt>Line 4</dt>
<dd>　Declares an empty finalize method. Processing equivalent to finalize can also be implemented by overriding tTJSNativeInstance::Invalidate, so an empty method is usually sufficient.
</dd>


<dt>Lines 7 through 16</dt>
<dd>　Declares a (TJS) constructor. When writing a class in TJS, it is equivalent to declaring a method with the same name as the class in the class.<br />
<br />
　The first argument of the TJS_BEGIN_NATIVE_CONSTRUCTOR_DECL macro is the variable name assigned to the native instance, and the second argument is the type name of the variable. Within this block in this example, the variables NI_Test * _this are available and you can access the native instance.<br />
　The third argument of the macro specifies the class name used in TJS. The same applies to the argument of the TJS_END_NATIVE_CONSTRUCTOR_DECL macro.<br />
　Here too, since the process equivalent to the constructor can be implemented by overriding tTJSNativeInstance::Construct, S_OK is returned without doing anything here.
</dd>


<dt>Lines 18 through 27</dt>
<dd>　Declares the print method. The method name must be the same in both the TJS_BEGIN_NATIVE_METHOD_DECL and TJS_END_NATIVE_METHOD_DECL macros.<br />
　The variables available in this macro are tjs_int numparams and tTJSVariant ** param, which indicate the number and arguments of the passed arguments, respectively. They are not used in this method.<br />
　Lines 20 to 21 are macros for extracting native instances from objects. In this example, it means to retrieve a native instance to a variable of type NI_Test * called _this. From now on, you can access the native instance with the variable _this. Line 23 calls the native instance's Print method.</dd>


<dt>Lines 29 through 40</dt>
<dd>　Declares the add method. Here we use numparams and param.</dd>



<dt>Lines 42 through 62</dt>
<dd>　Declares the value property. In the TJS_BEGIN_NATIVE_PROP_DECL and TJS_END_NATIVE_PROP_DECL macros, specify the property names as in the method declaration.<br />
<br />
　You can write getters between the TJS_BEGIN_NATIVE_PROP_GETTER and TJS_END_NATIVE_PROP_GETTER macros. In the getter, describe to set the value to * result which is tTJSVariant type.<br />
　Similarly, you can write a setter in the area between the TJS_BEGIN_NATIVE_PROP_SETTER and TJS_END_NATIVE_PROP_SETTER macros. In the setter, the value that should be set in * param which is tTJSVariant type is stored, and processing is performed using that value.</dd>


<dt>Lines 64 through 79</dt>
<dd>　Here we declare a read-only property. You can create read-only properties by writing TJS_DENY_NATIVE_PROP_SETTER instead of setters.</dd></dl><br />
<br />
<br />
　Registering a native class is the same as registering a native function. The following is an example of test code.<br />
<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*&nbsp;global&nbsp;=&nbsp;tjsengine-&gt;GetGlobalNoAddRef();<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Get&nbsp;global&nbsp;object</span><br />
<span class="linenumber">&nbsp;&nbsp;3|</span><br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*cls&nbsp;=&nbsp;new&nbsp;NC_Test();&nbsp;<span class="comment">//&nbsp;Create&nbsp;NC_Test&nbsp;object</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;cls_var(cls);&nbsp;<span class="comment">//&nbsp;Set&nbsp;object&nbsp;to&nbsp;tTJSVariant&nbsp;type&nbsp;cls_var</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cls-&gt;Release();&nbsp;<span class="comment">//&nbsp;Release&nbsp;cls</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_THROW_IF_ERROR(<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global-&gt;PropSet(TJS_MEMBERENSURE,&nbsp;TJS_W(&quot;Test&quot;),&nbsp;NULL,&nbsp;&amp;cls_var,&nbsp;NULL));<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Register</span><br />
<span class="linenumber">&nbsp;11|</span><br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;ExecScript(TJS_W(<br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;var&nbsp;test&nbsp;=&nbsp;new&nbsp;Test();\n&quot;<br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;test.value&nbsp;=&nbsp;5;\n&quot;<br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;var&nbsp;test2&nbsp;=&nbsp;new&nbsp;Test(test.square);\n&quot;<br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;test2.add(3);\n&quot;<br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;test2.print();\n\0&quot;),<br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;NULL,&nbsp;NULL);&nbsp;<span class="comment">//&nbsp;Run&nbsp;script</span><br />
</code>
<br />

<br />
</div></div>
	<script type="text/javascript" charset="UTF-8" src="documentid.js" ></script>
	<script type="text/javascript" charset="UTF-8" src="postcontent.js" ></script>
</body>
</html>
